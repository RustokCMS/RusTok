groups:
  - name: rustok_slo_alerts
    interval: 30s
    rules:
      # High Error Rate Alert
      - alert: HighErrorRate
        expr: |
          (
            rate(rustok_http_requests_total{status=~"5.."}[5m])
            /
            rate(rustok_http_requests_total[5m])
          ) > 0.05
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Slow Request Latency Alert
      - alert: SlowRequestLatency
        expr: |
          histogram_quantile(
            0.95,
            rate(rustok_http_request_duration_seconds_bucket[5m])
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "P95 latency is too high"
          description: "P95 latency is {{ $value | humanizeDuration }} (threshold: 500ms)"

      # Very Slow Request Latency Alert (Critical)
      - alert: VerySlowRequestLatency
        expr: |
          histogram_quantile(
            0.95,
            rate(rustok_http_request_duration_seconds_bucket[5m])
          ) > 1.0
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: "P95 latency is critically high"
          description: "P95 latency is {{ $value | humanizeDuration }} (threshold: 1s)"

  - name: rustok_eventbus_alerts
    interval: 30s
    rules:
      # High Event Queue Depth
      - alert: HighEventQueueDepth
        expr: rustok_event_bus_queue_depth > 7000
        for: 5m
        labels:
          severity: warning
          component: eventbus
        annotations:
          summary: "Event queue depth is high"
          description: "Event queue depth is {{ $value }} (threshold: 7000)"

      # Critical Event Queue Depth
      - alert: CriticalEventQueueDepth
        expr: rustok_event_bus_queue_depth > 10000
        for: 2m
        labels:
          severity: critical
          component: eventbus
        annotations:
          summary: "Event queue depth is critically high"
          description: "Event queue depth is {{ $value }} (threshold: 10000). Risk of memory exhaustion!"

      # Event Processing Errors
      - alert: HighEventProcessingErrors
        expr: rate(rustok_event_bus_errors_total[5m]) > 1
        for: 3m
        labels:
          severity: warning
          component: eventbus
        annotations:
          summary: "High event processing error rate"
          description: "Event errors: {{ $value | humanize }}/sec for {{$labels.event_type}}"

      # Event Lag Too High
      - alert: HighEventLag
        expr: |
          histogram_quantile(
            0.95,
            rate(rustok_event_bus_lag_seconds_bucket[5m])
          ) > 30
        for: 5m
        labels:
          severity: warning
          component: eventbus
        annotations:
          summary: "Event processing lag is too high"
          description: "P95 event lag is {{ $value | humanizeDuration }} (threshold: 30s)"

  - name: rustok_circuit_breaker_alerts
    interval: 30s
    rules:
      # Circuit Breaker Open
      - alert: CircuitBreakerOpen
        expr: rustok_circuit_breaker_state == 1
        for: 1m
        labels:
          severity: critical
          component: resilience
        annotations:
          summary: "Circuit breaker is open"
          description: "Circuit breaker for {{$labels.service}} is OPEN (failing fast)"

      # Circuit Breaker Half-Open (Info)
      - alert: CircuitBreakerHalfOpen
        expr: rustok_circuit_breaker_state == 2
        for: 30s
        labels:
          severity: info
          component: resilience
        annotations:
          summary: "Circuit breaker is half-open"
          description: "Circuit breaker for {{$labels.service}} is HALF-OPEN (testing recovery)"

      # High Circuit Breaker Failure Rate
      - alert: HighCircuitBreakerFailures
        expr: rustok_circuit_breaker_failures > 5
        for: 2m
        labels:
          severity: warning
          component: resilience
        annotations:
          summary: "High failure count in circuit breaker"
          description: "{{$labels.service}} has {{ $value }} failures (threshold: 5)"

  - name: rustok_cache_alerts
    interval: 30s
    rules:
      # Low Cache Hit Rate
      - alert: LowCacheHitRate
        expr: |
          (
            rate(rustok_cache_operations_total{result="hit"}[5m])
            /
            (
              rate(rustok_cache_operations_total{result="hit"}[5m])
              +
              rate(rustok_cache_operations_total{result="miss"}[5m])
            )
          ) < 0.5
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Cache hit rate is low"
          description: "Cache hit rate for {{$labels.cache}} is {{ $value | humanizePercentage }} (threshold: 50%)"

      # Very Low Cache Hit Rate
      - alert: VeryLowCacheHitRate
        expr: |
          (
            rate(rustok_cache_operations_total{result="hit"}[5m])
            /
            (
              rate(rustok_cache_operations_total{result="hit"}[5m])
              +
              rate(rustok_cache_operations_total{result="miss"}[5m])
            )
          ) < 0.2
        for: 5m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "Cache hit rate is critically low"
          description: "Cache hit rate for {{$labels.cache}} is {{ $value | humanizePercentage }} (threshold: 20%)"

      # High Cache Eviction Rate
      - alert: HighCacheEvictionRate
        expr: rate(rustok_cache_evictions_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "High cache eviction rate"
          description: "Cache {{$labels.cache}} is evicting {{ $value | humanize }} entries/sec"

  - name: rustok_database_alerts
    interval: 30s
    rules:
      # Slow Database Queries
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(
            0.95,
            rate(rustok_database_query_duration_seconds_bucket[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database queries are slow"
          description: "P95 query duration is {{ $value | humanizeDuration }} (threshold: 100ms)"

      # Very Slow Database Queries
      - alert: VerySlowDatabaseQueries
        expr: |
          histogram_quantile(
            0.95,
            rate(rustok_database_query_duration_seconds_bucket[5m])
          ) > 0.5
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database queries are critically slow"
          description: "P95 query duration is {{ $value | humanizeDuration }} (threshold: 500ms)"

      # High Database Query Errors
      - alert: HighDatabaseQueryErrors
        expr: rate(rustok_database_query_errors_total[5m]) > 0.5
        for: 3m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "High database query error rate"
          description: "Database errors: {{ $value | humanize }}/sec for {{$labels.query_type}}"

      # Low Database Connection Pool
      - alert: LowDatabaseConnections
        expr: rustok_database_connections{state="idle"} < 2
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Low idle database connections"
          description: "Only {{ $value }} idle connections available"

  - name: rustok_module_alerts
    interval: 30s
    rules:
      # Module Error Rate
      - alert: ModuleErrorRate
        expr: rate(rustok_module_errors_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          component: application
        annotations:
          summary: "High error rate in module"
          description: "Module {{$labels.module}} has {{ $value | humanize }} errors/sec"

      # Critical Module Error Rate
      - alert: CriticalModuleErrorRate
        expr: rate(rustok_module_errors_total{severity="critical"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "Critical errors in module"
          description: "Module {{$labels.module}} has {{ $value | humanize }} critical errors/sec"
